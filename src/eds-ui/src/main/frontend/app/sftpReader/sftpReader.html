<div class="module">
    <div class="module-heading">
        SFTP Reader Status
        <div class="pull-right">

            <form class="form-inline">

                <button class="btn btn-sm btn-default" (click)="odsSearch()" title="Ods Search">ODS Search</button>

                <div class="form-group">
                    Warnings Only
                    <input type="checkbox" id="showWarningsOnly" [(ngModel)]="showWarningsOnly" name="showWarningsOnly">
                </div>


                <div class="form-group">

                    <select id="filterInstanceName" name="filterInstanceName" class="form-control" [(ngModel)]="filterInstanceName" (ngModelChange)="refreshStatus()" >
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option *ngFor="let instanceName of instanceNames" value="{{instanceName.name}}">{{instanceName.name}}</option>
                        <option value="all">All</option>
                    </select>

                </div>

                <button class="btn btn-sm btn-success" [disabled]="refreshingStatus" (click)="refreshStatus()" >Refresh&nbsp;<span class="fa fa-sm fa-refresh fa-refresh-animate" *ngIf="refreshingStatus"></span></button>

            </form>

        </div>
    </div>
    <div class="module-body">

        <div *ngIf="statuses">

            <div class="row" *ngIf="showWarningsOnly && getStatusesToDisplay().length == 0">
                <div class="col-md-12">
                    No warnings found
                </div>
            </div>

            <div class="row" *ngFor="let status of getStatusesToDisplay()">
                <div class="col-md-12">
                    <div class="{{getPanelClass(status)}}">
                        <div class="panel-heading">
                            <b>{{status.name}}</b> ({{status.id}})
                        </div>

                        <div class="panel-body">

                            <div class="col-md-6">
                                <h4>Third Party->SFTP Reader</h4>

                                <div *ngIf="status.latestPollingStart">
                                    <span *ngIf="isLastPollAttemptTooOld(status)">
                                        <span class="label label-danger" *ngIf="isLastPollAttemptTooOld(status)">Warning</span>
                                        &nbsp;
                                    </span>
                                    Last Checked for Data: {{status.latestPollingStart | date:'dd-MMM-yyyy HH:mm:ss'}}
                                </div>
                                <div *ngIf="!status.latestPollingStart">
                                    <span class="label label-danger">Warning</span>&nbsp;Last Checked for Data: NEVER
                                </div>

                                <div *ngIf="status.latestPollingException">
                                    <span class="label label-danger">Warning</span>
                                    &nbsp;Error on last polling attempt:
                                    <pre>{{status.latestPollingException}}</pre>
                                </div>

                                <div *ngIf="status.latestBatchId">
                                    <div>
                                        <span *ngIf="isLastExtractTooOld(status)">
                                        <span class="label label-danger" *ngIf="isLastExtractTooOld(status)">Warning</span>
                                        &nbsp;
                                    </span>
                                        Last Extract Received: {{status.latestBatchReceived | date:'dd-MMM-yyyy HH:mm:ss'}}
                                    </div>
                                    <div>Data From: {{status.latestBatchIdentifier}}</div>
                                    <div>Extract Sequence No: {{status.latestBatchSequenceNumber}}</div>
                                    <div>Files Received: {{status.latestBatchFileCount}}</div>
                                    <div>Extract Size: {{status.latestBatchSizeBytes}}</div>

                                    <div *ngIf="status.latestBatchComplete">
                                        <div>Extract Valid and Complete: YES</div>
                                    </div>
                                    <div *ngIf="!status.latestBatchComplete">
                                        <div>Extract Valid and Complete: NO</div>
                                    </div>
                                </div>
                                <div *ngIf="!status.latestBatchId">
                                    <span class="label label-danger">Warning</span>
                                    &nbsp;Last Extract Received: NEVER
                                </div>

                            </div>
                            <div class="col-md-6">
                                <h4>SFTP Reader->Messaging API</h4>



                                <div *ngIf="status.completeBatchId">
                                    <div>Extract Received: {{status.completeBatchReceived | date:'dd-MMM-yyyy HH:mm:ss'}}</div>
                                    <div>Data From: {{status.completeBatchIdentifier}}</div>
                                    <div>Extract Sequence No: {{status.completeBatchSequenceNumber}}</div>

                                    <ngb-accordion #acc="ngbAccordion">
                                        <ngb-panel title="Organisations in extract: {{status.completeBatchContents.length}}">
                                            <template ngbPanelContent>

                                                <table class="table table-striped table-condensed">
                                                    <thead>
                                                    <tr>
                                                        <th class="col-md-2">ODS Code</th>
                                                        <th class="col-md-2">Status</th>
                                                        <th class="col-md-8">Error</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    <tr class="hover-box" *ngFor="let content of status.completeBatchContents">
                                                        <td>{{content.orgId}}</td>
                                                        <td *ngIf="content.notified">OK</td>
                                                        <td *ngIf="!content.notified">Error</td>
                                                        <td>{{content.error}}</td>
                                                    </tr>
                                                    </tbody>
                                                </table>

                                            </template>
                                        </ngb-panel>
                                    </ngb-accordion>

                                    <div *ngIf="filterOrgs(status.completeBatchContents, true).length > 0">
                                        <ngb-accordion #acc="ngbAccordion">
                                            <ngb-panel title="Organisations posted OK: {{filterOrgs(status.completeBatchContents, true).length}}">
                                                <template ngbPanelContent>

                                                    <table class="table table-striped table-condensed">
                                                        <thead>
                                                        <tr>
                                                            <th class="col-md-2">ODS Code</th>
                                                            <th class="col-md-2">Status</th>
                                                            <th class="col-md-8">Error</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        <tr class="hover-box" *ngFor="let content of filterOrgs(status.completeBatchContents, true)">
                                                            <td>{{content.orgId}}</td>
                                                            <td *ngIf="content.notified">OK</td>
                                                            <td *ngIf="!content.notified">Error</td>
                                                            <td>{{content.error}}</td>
                                                        </tr>
                                                        </tbody>
                                                    </table>

                                                </template>
                                            </ngb-panel>
                                        </ngb-accordion>
                                    </div>

                                    <div *ngIf="filterOrgs(status.completeBatchContents, false).length > 0">
                                        <span class="label label-danger">Warning</span>

                                        <ngb-accordion #acc="ngbAccordion">
                                            <ngb-panel title="Organisations in Error: {{filterOrgs(status.completeBatchContents, false).length}}">
                                                <template ngbPanelContent>

                                                    <table class="table table-striped table-condensed">
                                                        <thead>
                                                        <tr>
                                                            <th class="col-md-2">ODS Code</th>
                                                            <th class="col-md-2">Status</th>
                                                            <th class="col-md-8">Error</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        <tr class="hover-box" *ngFor="let content of filterOrgs(status.completeBatchContents, false)">
                                                            <td>{{content.orgId}}</td>
                                                            <td *ngIf="content.notified">OK</td>
                                                            <td *ngIf="!content.notified">Error</td>
                                                            <td>{{content.error}}</td>
                                                        </tr>
                                                        </tbody>
                                                    </table>

                                                </template>
                                            </ngb-panel>
                                        </ngb-accordion>
                                    </div>

                                </div>
                                <div *ngIf="!status.completeBatchId">
                                    <div>No complete batches received to send to Messaging API</div>
                                </div>

                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    Show raw JSON<input type="checkbox" id="showRawJson" [(ngModel)]="showRawJson" name="showRawJson">
                    <pre *ngIf="showRawJson">{{resultStr}}</pre>
                </div>
            </div>


        </div>


    </div>
</div>


